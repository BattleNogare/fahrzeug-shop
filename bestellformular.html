<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Fahrzeug-Bestellung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Darkmode / Theme â€“ wiederverwende deine katalog.css -->
    <link rel="stylesheet" href="katalog.css">

    <!-- YAML Parser -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

    <style>
        /* Du kannst das in deine katalog.css verschieben */

        .order-page-header {
            margin-top: 1.5rem;
        }

        .order-form-card {
            margin-top: 1.4rem;
            padding: 1.2rem 1.3rem;
            border-radius: 18px;
            border: 1px solid var(--border-subtle, #222633);
            background:
                radial-gradient(800px 450px at 0% 0%, rgba(255, 153, 0, 0.08), transparent 65%),
                rgba(10, 12, 20, 0.96);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
        }

        .order-form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.1rem 1.4rem;
        }
        @media (max-width: 780px) {
            .order-form-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .order-field {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .order-label {
            font-size: 0.9rem;
            color: var(--text-muted, #9ca3af);
        }

        .order-input,
        .order-textarea,
        .order-select {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-subtle, #222633);
            background: rgba(5, 7, 13, 0.95);
            color: var(--text, #f5f5f5);
            font: inherit;
            padding: 0.5rem 0.65rem;
        }

        .order-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .order-input:focus,
        .order-textarea:focus,
        .order-select:focus {
            outline: 2px solid rgba(255, 153, 0, 0.5);
            outline-offset: 1px;
        }

        .order-items-section {
            margin-top: 1.2rem;
        }

        .order-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .order-items-header h2 {
            margin: 0;
            font-size: 1rem;
        }

        .order-items-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .order-item-row {
            display: grid;
            grid-template-columns: minmax(0, 2.5fr) 0.8fr auto;
            gap: 0.45rem;
            align-items: center;
        }
        @media (max-width: 780px) {
            .order-item-row {
                grid-template-columns: minmax(0, 1.8fr) 0.8fr auto;
            }
        }

        .order-qty-input {
            max-width: 100px;
        }

        .order-remove-btn,
        .order-add-btn,
        .order-submit-btn {
            border-radius: 999px;
            border: 1px solid var(--border-subtle, #222633);
            background: rgba(12, 14, 24, 0.96);
            color: var(--text-muted, #9ca3af);
            cursor: pointer;
            font: inherit;
            padding: 0.4rem 0.9rem;
            transition: transform 0.16s ease-out,
                        box-shadow 0.16s ease-out,
                        background 0.16s ease-out,
                        color 0.16s ease-out,
                        border-color 0.16s ease-out;
        }

        .order-add-btn {
            font-size: 0.9rem;
            border-style: dashed;
        }

        .order-remove-btn {
            font-size: 0.8rem;
            padding-inline: 0.6rem;
        }

        .order-submit-btn {
            background: var(--accent, #ff9900);
            color: #000;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            padding-inline: 1.4rem;
        }

        .order-add-btn:hover,
        .order-remove-btn:hover {
            background: rgba(30, 41, 59, 0.95);
            color: var(--text, #f5f5f5);
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.8);
        }

        .order-submit-btn:hover {
            background: #ffb341;
            border-color: var(--accent, #ff9900);
            transform: translateY(-1px);
            box-shadow: 0 16px 34px rgba(0, 0, 0, 0.9);
        }

        .order-footer-row {
            margin-top: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .order-total {
            font-size: 0.95rem;
            color: var(--text-muted, #9ca3af);
        }
        .order-total strong {
            color: var(--text, #f5f5f5);
        }

        .order-status {
            margin-top: 0.7rem;
            font-size: 0.9rem;
            min-height: 1.2em;
            color: var(--text-muted, #9ca3af);
        }
        .order-status.ok {
            color: #4ade80;
        }
        .order-status.err {
            color: #fb7185;
        }
    </style>
</head>
<body class="catalog-body">
<div class="catalog-page">

    <header class="catalog-header order-page-header">
        <div class="catalog-header-brand">
            <h1 class="catalog-title">Fahrzeug-Bestellung</h1>
            <p class="catalog-subtitle">Bestellen Sie hier Fahrzeuge aus unserem Katalog</p>
        </div>
    </header>

    <section class="order-form-card">
        <div id="orderHint" class="catalog-hint">ðŸ”„ Lade Fahrzeugliste â€¦</div>

        <form id="orderForm" autocomplete="off">
            <div class="order-form-grid">
                <div class="order-field">
                    <label for="customerName" class="order-label">Ihr Name *</label>
                    <input id="customerName" name="customerName" class="order-input" required>
                </div>
                <div class="order-field">
                    <label for="customerContact" class="order-label">Kontakt (E-Mail / Telefon) *</label>
                    <input id="customerContact" name="customerContact" class="order-input" required>
                </div>
                <div class="order-field">
                    <label for="customerCompany" class="order-label">Firma (optional)</label>
                    <input id="customerCompany" name="customerCompany" class="order-input">
                </div>
                <div class="order-field">
                    <label for="customerNote" class="order-label">Bemerkung zur Bestellung</label>
                    <textarea id="customerNote" name="customerNote" class="order-textarea"></textarea>
                </div>
            </div>

            <div class="order-items-section">
                <div class="order-items-header">
                    <h2>Fahrzeuge &amp; Mengen</h2>
                    <button type="button" id="addItemBtn" class="order-add-btn">+ weiteres Fahrzeug</button>
                </div>
                <div id="orderItems" class="order-items-list"></div>
            </div>

            <div class="order-footer-row">
                <div class="order-total">
                    Gesamtmenge: <strong id="orderTotalQty">0</strong> Fahrzeuge
                </div>
                <button type="submit" class="order-submit-btn">Bestellung absenden</button>
            </div>

            <div id="orderStatus" class="order-status" aria-live="polite"></div>
        </form>
    </section>

    <footer class="catalog-footer">
        <p class="catalog-footer-text">
            Â© <span id="orderYear"></span> Fahrzeug-Shop
        </p>
    </footer>
</div>

<script>
(function(){
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/DEINE_WEB_APP_URL/exec"; // TODO anpassen
    const YAML_URL       = "fahrzeuge.yaml";

    const yearEl        = document.getElementById("orderYear");
    const orderHint     = document.getElementById("orderHint");
    const orderForm     = document.getElementById("orderForm");
    const orderItemsEl  = document.getElementById("orderItems");
    const addItemBtn    = document.getElementById("addItemBtn");
    const orderStatusEl = document.getElementById("orderStatus");
    const totalQtyEl    = document.getElementById("orderTotalQty");

    if(yearEl){ yearEl.textContent = new Date().getFullYear(); }

    let vehicles = [];

    function normalizeVehicle(raw){
        if(!raw || typeof raw !== "object") return {};
        return {
            id:   raw.id   || raw.ID   || null,
            name: raw.name || raw.Name || "",
            neupreis: raw.neupreis || raw.Neupreis || null
        };
    }

    function updateTotalQty(){
        const rows = orderItemsEl.querySelectorAll(".order-item-row");
        let total = 0;
        rows.forEach(row => {
            const qtyInput = row.querySelector(".order-qty-input");
            const qty = parseInt(qtyInput.value, 10) || 0;
            total += qty;
        });
        totalQtyEl.textContent = String(total);
    }

    function createOrderItemRow(){
        const row = document.createElement("div");
        row.className = "order-item-row";

        const select = document.createElement("select");
        select.className = "order-select order-vehicle-select";
        select.required = true;

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Fahrzeug auswÃ¤hlen â€¦";
        select.appendChild(placeholder);

        vehicles.forEach((v, idx) => {
            const opt = document.createElement("option");
            opt.value = v.id || String(idx);
            opt.textContent = v.name || ("Fahrzeug " + (idx + 1));
            select.appendChild(opt);
        });

        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min  = "1";
        qtyInput.value= "1";
        qtyInput.className = "order-input order-qty-input";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "order-remove-btn";
        removeBtn.textContent = "â€“";

        select.addEventListener("change", updateTotalQty);
        qtyInput.addEventListener("input", updateTotalQty);
        removeBtn.addEventListener("click", () => {
            if(orderItemsEl.children.length > 1){
                row.remove();
                updateTotalQty();
            }
        });

        row.appendChild(select);
        row.appendChild(qtyInput);
        row.appendChild(removeBtn);
        return row;
    }

    async function loadVehicles(){
        try{
            const res = await fetch(YAML_URL);
            if(!res.ok) throw new Error("fahrzeuge.yaml nicht erreichbar (" + res.status + ")");
            const text = await res.text();
            const data = jsyaml.load(text);
            const list = (data && (data.fahrzeuge || data.vehicles)) || [];
            vehicles = list.map(normalizeVehicle).filter(v => v.name);

            if(orderHint){
                orderHint.style.display = "none";
            }

            orderItemsEl.innerHTML = "";
            orderItemsEl.appendChild(createOrderItemRow());
            updateTotalQty();
        }catch(err){
            console.error(err);
            if(orderHint){
                orderHint.textContent = "âŒ Fehler beim Laden der Fahrzeugliste: " + err.message;
                orderHint.classList.add("catalog-hint-error");
            }
        }
    }

    orderForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        orderStatusEl.textContent = "";
        orderStatusEl.className = "order-status";

        const name    = document.getElementById("customerName").value.trim();
        const contact = document.getElementById("customerContact").value.trim();
        const company = document.getElementById("customerCompany").value.trim();
        const note    = document.getElementById("customerNote").value.trim();

        if(!name || !contact){
            orderStatusEl.textContent = "Bitte Name und Kontakt ausfÃ¼llen.";
            orderStatusEl.classList.add("err");
            return;
        }

        const rows = orderItemsEl.querySelectorAll(".order-item-row");
        const items = [];
        rows.forEach(row => {
            const select = row.querySelector(".order-vehicle-select");
            const qtyInput = row.querySelector(".order-qty-input");
            if(!select || !qtyInput) return;

            const id  = select.value;
            const qty = parseInt(qtyInput.value, 10) || 0;
            if(!id || qty <= 0) return;

            const v = vehicles.find(x => (x.id || "") === id) || vehicles[select.selectedIndex - 1];
            const name = v ? v.name : "Unbekanntes Fahrzeug";

            items.push({
                vehicleId: id,
                vehicleName: name,
                quantity: qty
            });
        });

        if(!items.length){
            orderStatusEl.textContent = "Bitte mindestens ein Fahrzeug mit Menge angeben.";
            orderStatusEl.classList.add("err");
            return;
        }

        const payload = {
            action: "createOrder",
            order: {
                customerName: name,
                customerContact: contact,
                customerCompany: company,
                customerNote: note,
                items: items
            }
        };

        try{
            orderStatusEl.textContent = "Sende Bestellung â€¦";
            const res = await fetch(APP_SCRIPT_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));

            if(!res.ok || data.status !== "ok"){
                throw new Error(data.message || ("Fehlercode " + res.status));
            }

            orderStatusEl.textContent = "Danke! Ihre Bestellung wurde gespeichert.";
            orderStatusEl.classList.add("ok");

            orderForm.reset();
            orderItemsEl.innerHTML = "";
            orderItemsEl.appendChild(createOrderItemRow());
            updateTotalQty();
        }catch(err){
            console.error(err);
            orderStatusEl.textContent = "Fehler beim Senden der Bestellung: " + err.message;
            orderStatusEl.classList.add("err");
        }
    });

    addItemBtn.addEventListener("click", () => {
        if(!vehicles.length) return;
        orderItemsEl.appendChild(createOrderItemRow());
        updateTotalQty();
    });

    document.addEventListener("DOMContentLoaded", loadVehicles);
})();
</script>
</body>
</html>
